<!doctype html>
<html>
  <head>
    <title>Web.py server test</title>
    <style>
table.coords {
      margin-left: auto;
      margin-right: auto;
      width: 300px;
}
table.coords td.name {
      font-weight: bold;
      width: 25px;
}
table.coords td.value {
      color: blue;
}
#stick {
      margin-left: auto;
      margin-right: auto;
      display: block;
}
#background {
      fill: #ccf;
}
#foreground {
      fill-opacity: 0;
}
#circle_red {
      fill: #afa;
      stroke: red;
      stroke-width: 4;
}
#circle_blue {
      fill: #aaa;
      stroke: blue;
      stroke-width: 4;
}
    </style>
    <script type="text/javascript">
function periodic_update () {
/// Retrieve latest values from server & update the page
/// (Take a look at https://www.html5rocks.com/en/tutorials/file/xhr2/ for getting binary data, e.g., images)
    var query = new XMLHttpRequest ();
    query.open ("GET", "/query?name=circle_blue_xy");
    query.responseType = "text";
    query.onload = function (e) {
        var text = this.response;

        var coords = text.split (','); /// comma-separated list of numbers -> array of strings
        if (coords.length == 2) {
            var c_blue = document.getElementById ("circle_blue"); /// in this case, move the blue circle...

            c_blue.setAttribute ("cx", coords[0]);
            c_blue.setAttribute ("cy", coords[1]);
        }
    }
    query.send ();
}

function get_started () {
    window.setInterval (periodic_update, 100); /// interval in milliseconds
}
window.onload = get_started;
    </script>
  </head>
  <body ondragstart="return false;" ondrop="return false;">
    <table class="coords">
      <tr><td class="name">X:</td><td class="value" id="value_x">uninitialised</td></tr>
      <tr><td class="name">Y:</td><td class="value" id="value_y">uninitialised</td></tr>
    </table>
    <svg id="stick" width="500" height="500">
      <rect id="background" x="0" y="0" width="500" height="500" />
      <!-- Previous line adds a coloured background --->

      <circle id="circle_red" cx="50" cy="50" r="40" />
      <circle id="circle_blue" cx="50" cy="50" r="40" />

      <!-- Finally: Add a transparent overlay to simplfy event handling --->
      <rect id="foreground" x="0" y="0" width="500" height="500" />
    </svg>
    <script type="text/javascript">
///
function myFn (event, type) {
    var svg_box = document.getElementById ("foreground");
    var value_x = document.getElementById ("value_x");
    var value_y = document.getElementById ("value_y");

    var rect = svg_box.getBoundingClientRect ();

    var x = event.clientX - rect.x;
    var y = event.clientY - rect.y;

    if (x < 0) {
	x = 0;
    }
    if (y < 0) {
	y = 0;
    }
    if (x > rect.width) {
	x = rect.width;
    }
    if (y > rect.height) {
	y = rect.height;
    }

    value_x.innerHTML = (2 * x / rect.width  - 1).toFixed (3);
    value_y.innerHTML = (2 * y / rect.height - 1).toFixed (3);

    if ((event.buttons === 0) && (event.button === 0)) {
	x = rect.width / 2;
	y = rect.height / 2;
    }

    var c_red = document.getElementById ("circle_red");

    c_red.setAttribute ("cx", x.toFixed (3));
    c_red.setAttribute ("cy", y.toFixed (3));
}

function e_down (event) {
    myFn (event, "down");
}
function e_up (event) {
    myFn (event, "up");
}
function e_over (event) {
    myFn (event, "over");
}
function e_move (event) {
    myFn (event, "move");
}
function e_out (event) {
    myFn (event, "out");
}
	
var stick = document.getElementById ("foreground");

stick.addEventListener ("mousedown", e_down, false);
stick.addEventListener ("mouseup",   e_up,   false);
stick.addEventListener ("mouseover", e_over, false);
stick.addEventListener ("mousemove", e_move, false);
stick.addEventListener ("mouseout",  e_out,  false);
///
    </script>
    <p>Click <a href="/command?name=stop">here</a> to stop.</p>
  </body>
</html>
